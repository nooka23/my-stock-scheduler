# ======================================================================================
# ğŸ“˜ ì´ˆë³´ìë¥¼ ìœ„í•œ ì½”ë“œ ì„¤ëª…ì„œ: ì£¼ì‹ ë°ì´í„° ì „ì²´ JSON ë³€í™˜ê¸° (update_prices_json.py)
# ======================================================================================
# ì´ í”„ë¡œê·¸ë¨ì€ ì£¼ì‹ ë°ì´í„°ë¥¼ í†µì§¸ë¡œ ê°€ì ¸ì™€ì„œ JSONì´ë¼ëŠ” íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•œ ë’¤,
# Supabase 'ì €ì¥ì†Œ(Storage)'ì— íŒŒì¼ ìì²´ë¥¼ ì˜¬ë ¤ë²„ë¦¬ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.
# 
# ì´ì „ ì½”ë“œ(update_today_v2)ê°€ ë°ì´í„°ë¥¼ ì˜ê²Œ ìª¼ê°œì„œ 'í‘œ(Table)'ì— ë„£ëŠ” ê²ƒì´ë¼ë©´,
# ì´ ì½”ë“œëŠ” ì±… í•œ ê¶Œ(ì£¼ê°€ ì „ì²´ ì—­ì‚¬)ì„ í†µì§¸ë¡œ 'ë„ì„œê´€(Storage)'ì— ê½‚ì•„ë„£ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
# ì°¨íŠ¸ ê·¸ë¦¬ê¸°ìš© ë°ì´í„°ë¥¼ í•œë°©ì— ë¡œë”©í•  ë•Œ ì•„ì£¼ ë¹ ë¥´ê³  ì¢‹ìŠµë‹ˆë‹¤.
# ======================================================================================

# 1ï¸âƒ£ í•„ìš”í•œ ë„êµ¬(ë¼ì´ë¸ŒëŸ¬ë¦¬)ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
import os                                   # ìš´ì˜ì²´ì œ ë„êµ¬
import FinanceDataReader as fdr             # ì£¼ì‹ ë°ì´í„° ìˆ˜ì§‘ ë„êµ¬
import pandas as pd                         # ë°ì´í„° í‘œ(DataFrame) ì²˜ë¦¬ ë„êµ¬
from supabase import create_client, Client  # Supabase í†µì‹  ë„êµ¬
from dotenv import load_dotenv              # í™˜ê²½ë³€ìˆ˜(.env) ë¡œë”
import time                                 # ì‹œê°„ ì œì–´ ë„êµ¬
import json                                 # JSON í˜•ì‹ ë°ì´í„° ì²˜ë¦¬ ë„êµ¬
from datetime import datetime               # ë‚ ì§œ ì²˜ë¦¬ ë„êµ¬

# 2ï¸âƒ£ ì„¤ì • ë¡œë“œ ë° ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
load_dotenv('.env.local')

url = os.environ.get("NEXT_PUBLIC_SUPABASE_URL")
key = os.environ.get("SUPABASE_SERVICE_KEY") # ì—¬ê¸°ì„œëŠ” Service Key(ê´€ë¦¬ì í‚¤)ë¥¼ ì”ë‹ˆë‹¤. ê¶Œí•œì´ ë” ì…‰ë‹ˆë‹¤.

if not url or not key:
    print("Error: .env.local íŒŒì¼ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
    exit()

supabase: Client = create_client(url, key)

print("ğŸš€ ì£¼ê°€ ë°ì´í„° ì „ì²´ ì—…ë°ì´íŠ¸ ì‹œì‘ (JSON ë°©ì‹)")

# ---------------------------------------------------------
# 3ï¸âƒ£ ëŒ€ìƒ ì¢…ëª© ì„ ì • (ì§„ì§œ ê¸°ì—…ë§Œ ê³¨ë¼ë‚´ê¸°)
# ---------------------------------------------------------
print("1. ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...")
try:
    # í•œêµ­ê±°ë˜ì†Œ(KRX) ì „ì²´ ì¢…ëª© ê°€ì ¸ì˜¤ê¸°
    df_krx = fdr.StockListing('KRX')
    
    # Sector(ì—…ì¢…) ì •ë³´ê°€ ìˆëŠ” ê²ƒë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    # ìŠ¤íŒ©(SPAC)ì´ë‚˜ ETF ê°™ì€ ê¸ˆìœµ ìƒí’ˆì€ ë³´í†µ 'ì—…ì¢…' ì •ë³´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.
    # ì¦‰, notnull()ì„ ì“°ë©´ "ì§„ì§œ ì‚¬ì—…ì„ í•˜ëŠ” íšŒì‚¬"ë“¤ë§Œ ë‚¨ê²Œ ë©ë‹ˆë‹¤.
    real_companies = df_krx[df_krx['Sector'].notnull()]
    
    # í•„ìš”í•œ ì •ë³´(ì½”ë“œ, ì´ë¦„)ë§Œ ë½‘ì•„ì„œ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“­ë‹ˆë‹¤.
    target_stocks = real_companies[['Code', 'Name']].to_dict('records')
    print(f"âœ… ì „ì²´ {len(df_krx)}ê°œ ì¤‘ 'ì‹¤ì œ ê¸°ì—…' {len(target_stocks)}ê°œ ì„ ë³„ ì™„ë£Œ")
    
except Exception as e:
    print(f"âŒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
    exit()

# ---------------------------------------------------------
# 4ï¸âƒ£ ë°ì´í„° ìˆ˜ì§‘ ë° ì—…ë¡œë“œ (ì—¬ê¸°ê°€ ë©”ì¸ ê³µì¥ì…ë‹ˆë‹¤!)
# ---------------------------------------------------------
# 2010ë…„ 1ì›” 1ì¼ë¶€í„°ì˜ ê¸´ ì—­ì‚¬ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
START_DATE = '2010-01-01'
failed_list = [] # ì‹¤íŒ¨í•œ ì• ë“¤ì€ ì—¬ê¸° ì ì–´ë’€ë‹¤ê°€ ë‚˜ì¤‘ì— í˜¼ë‚´ì¤ë‹ˆë‹¤(í™•ì¸í•©ë‹ˆë‹¤).

print(f"2. {START_DATE} ~ í˜„ì¬ ë°ì´í„° ìˆ˜ì§‘ ë° ì—…ë¡œë“œ...")

# enumerateë¡œ ë²ˆí˜¸í‘œ(idx)ì™€ ë°ì´í„°(stock)ë¥¼ í•˜ë‚˜ì”© êº¼ëƒ…ë‹ˆë‹¤.
for idx, stock in enumerate(target_stocks):
    code = stock['Code']
    name = stock['Name']
    
    # 50ë²ˆì§¸ë§ˆë‹¤ ìƒì¡´ ì‹ ê³  (í™”ë©´ì— ì§„í–‰ ìƒí™© ì¶œë ¥)
    if idx % 50 == 0:
        print(f"[{idx+1}/{len(target_stocks)}] {name}({code}) ì§„í–‰ ì¤‘...")

    try:
        # ğŸ’¡ [ë°ì´í„° ìˆ˜ì§‘]
        # KRX:005930 ì²˜ëŸ¼ ì•ì— 'KRX:'ë¥¼ ë¶™ì—¬ì„œ í•œêµ­ê±°ë˜ì†Œ ë°ì´í„°ì„ì„ ëª…í™•íˆ í•©ë‹ˆë‹¤.
        df = fdr.DataReader(f'KRX:{code}', START_DATE)
        
        # ë°ì´í„°ê°€ í…… ë¹„ì—ˆìœ¼ë©´(ìƒì¥ íì§€ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜) íŒ¨ìŠ¤!
        if df.empty:
            print(f"   âš ï¸ {name}({code}) ë°ì´í„° ì—†ìŒ (Pass)")
            continue

        # ğŸ’¡ [ë°ì´í„° ê°€ê³µ]
        # ì›ë³¸ ë°ì´í„°ëŠ” ë‚ ì§œê°€ 'ì¸ë±ìŠ¤(Index)'ë¼ëŠ” íŠ¹ìˆ˜í•œ ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤.
        # ì´ê±¸ ì¼ë°˜ 'ì»¬ëŸ¼(Column)'ìœ¼ë¡œ ëŒì–´ë‚´ë¦¬ëŠ” ì‘ì—…ì´ reset_index() ì…ë‹ˆë‹¤.
        df = df.reset_index()
        
        # ë‚ ì§œë¥¼ '2025-12-05' ê°™ì€ ë¬¸ìì—´ ëª¨ì–‘ìœ¼ë¡œ ì˜ˆì˜ê²Œ ë‹¤ë“¬ìŠµë‹ˆë‹¤.
        df['Date'] = df['Date'].dt.strftime('%Y-%m-%d')
        
        # ì°¨íŠ¸ ê·¸ë¦¬ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬(TradingView ë“±)ê°€ ì¢‹ì•„í•˜ëŠ” ì˜ì–´ ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤.
        df = df[['Date', 'Open', 'High', 'Low', 'Close', 'Volume']]
        df.columns = ['time', 'open', 'high', 'low', 'close', 'volume']
        
        # í‘œ(DataFrame)ë¥¼ JSON(ê¸€ì ë©ì–´ë¦¬) í˜•íƒœë¡œ ë°”ê¿‰ë‹ˆë‹¤.
        # orient='records'ëŠ” [{time:..., open:...}, {time:..., open:...}] ì´ëŸ° ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
        json_data = df.to_json(orient='records')

        # ğŸ’¡ [ì—…ë¡œë“œ & ì¬ì‹œë„ ë¡œì§]
        # ì¸í„°ë„·ì€ ê°€ë” ë¶ˆì•ˆì •í•˜ê³ , ì„œë²„ë„ ë°”ì˜ë©´ "ì ê¹ë§Œìš”!(429 ì—ëŸ¬)"ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # ê·¸ë˜ì„œ 5ë²ˆê¹Œì§€ëŠ” ë´ì£¼ê³  ë‹¤ì‹œ ì‹œë„í•˜ëŠ” 'ëˆê¸°'ë¥¼ ì½”ë”©í•©ë‹ˆë‹¤.
        max_retries = 5
        for attempt in range(max_retries):
            try:
                # Supabaseì˜ 'stocks'ë¼ëŠ” íŒŒì¼ ì €ì¥ì†Œ(Storage)ì— ì˜¬ë¦½ë‹ˆë‹¤.
                # íŒŒì¼ëª…ì€ 'ì¢…ëª©ì½”ë“œ.json' (ì˜ˆ: 005930.json)
                supabase.storage.from_("stocks").upload(
                    file=json_data.encode('utf-8'), # ê¸€ìë¥¼ ì»´í“¨í„°ê°€ ì´í•´í•˜ëŠ” ë°”ì´íŠ¸(byte)ë¡œ ë³€í™˜
                    path=f"{code}.json",
                    file_options={"content-type": "application/json", "upsert": "true"} # upsert=true: ì´ë¯¸ ìˆìœ¼ë©´ ë®ì–´ì¨ë¼!
                )
                break # ì„±ê³µí–ˆìœ¼ë©´ ë°˜ë³µë¬¸ íƒˆì¶œ! (ë‹¤ìŒ ì¢…ëª©ìœ¼ë¡œ)
            
            except Exception as upload_err:
                error_msg = str(upload_err)
                
                # "429 Too Many Requests" ì—ëŸ¬ëŠ” "ë„ˆë¬´ ë¹¨ë¼ìš”! ì²œì²œíˆ ë³´ë‚´ì£¼ì„¸ìš”" ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.
                if "429" in error_msg or "Too Many Requests" in error_msg:
                    # ì‹¤íŒ¨ íšŸìˆ˜ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ ë” ì˜¤ë˜ ê¸°ë‹¤ë¦½ë‹ˆë‹¤ (5ì´ˆ -> 10ì´ˆ -> 15ì´ˆ...)
                    wait_time = (attempt + 1) * 5 
                    if attempt == 0: 
                        print(f"   â³ ì†ë„ ì œí•œ! {wait_time}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„...")
                    time.sleep(wait_time)
                
                # ë§ˆì§€ë§‰ ì‹œë„(4ë²ˆ ì¸ë±ìŠ¤ = 5ë²ˆì§¸)ê¹Œì§€ ì‹¤íŒ¨í•˜ë©´?
                elif attempt == max_retries - 1:
                    raise upload_err # í¬ê¸°í•˜ê³  ì—ëŸ¬ë¥¼ ë°–ìœ¼ë¡œ ë˜ì§‘ë‹ˆë‹¤. (catch ë¸”ë¡ìœ¼ë¡œ ì´ë™)
                else:
                    # ê·¸ ì™¸ ìì˜í•œ ì—ëŸ¬ëŠ” 1ì´ˆë§Œ ì‰¬ê³  ë‹¤ì‹œ í•´ë´…ë‹ˆë‹¤.
                    time.sleep(1)

    except Exception as e:
        # ì—¬ê¸°ì„œ ì¡íˆë©´ ì§„ì§œ ìµœì¢… ì‹¤íŒ¨ì…ë‹ˆë‹¤.
        print(f"   âŒ {name}({code}) ìµœì¢… ì‹¤íŒ¨: {e}")
        # ì‹¤íŒ¨ ëª…ë‹¨ì— ì ì–´ë‘¡ë‹ˆë‹¤.
        failed_list.append({"code": code, "name": name, "error": str(e)})
        
    # ë„ˆë¬´ ë§¹ë ¬í•˜ê²Œ ë‹¬ë¦¬ë©´ ì„œë²„ê°€ í˜ë“¤ì–´í•˜ë‹ˆê¹Œ ì¢…ëª© í•˜ë‚˜ ëë‚  ë•Œë§ˆë‹¤ 0.05ì´ˆ ì‰½ë‹ˆë‹¤.
    time.sleep(0.05)

# ---------------------------------------------------------
# 5ï¸âƒ£ ê²°ê³¼ ë¦¬í¬íŠ¸ (ì„±ì í‘œ)
# ---------------------------------------------------------
print("\n" + "="*30)
if failed_list:
    # ì‹¤íŒ¨í•œ ê²Œ ìˆìœ¼ë©´ íŒŒì¼ë¡œ ì €ì¥í•´ì„œ ë‚˜ì¤‘ì— ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
    print(f"ğŸš¨ ì‘ì—… ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ {len(failed_list)}ê°œ ì¢…ëª© ì‹¤íŒ¨.")
    with open('failed_companies.json', 'w', encoding='utf-8') as f:
        json.dump(failed_list, f, ensure_ascii=False, indent=2)
    print("ğŸ‘‰ 'failed_companies.json' íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
else:
    # ì™„ë²½í•˜ë©´ ì¶•í•˜ ë©”ì‹œì§€!
    print("ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤! ëª¨ë“  ì¢…ëª© ì—…ë¡œë“œ ì„±ê³µ!")
